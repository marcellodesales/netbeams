<!-- Imported by every ant build file. -->
<project name="DSP Core" basedir=".">
	
    <property environment="env"/>
	<dirname property="imported.basedir" file="${ant.file.imported}"/> 
	<property name="running.file" value="${ant.file}"/> 

	<!-- DEVELOPMENT CONSTANT NECESSARY: KNOPFLERFISH_HOME -->
    <property name="KNOPFLERFISH.HOME" location="/home/marcello/development/workspaces/opensource/knopflerfish2.1.0/knopflerfish.org" />
	<!-- DEVELOPMENT CONSTANT NECESSARY: DSP_HOME -->
	<property name="DSP.HOME" value="/home/marcello/development/workspaces/sfsu/netBEAMS2 OSGi General" />
	<!-- DEVELOPMENT CONSTANT OPTIONAL: DSP.KNOPFLERFISH.EXEC 
	   The name of the script to execute knopflerfish with support  to DSP, Log4J, etc. -->
	<property name="DSP.KNOPFLERFISH.EXEC" value="start-knopflerfish-for-dsp" />
	
	<property name="CORE.DIR" value="${DSP.HOME}/versions/v2/" />
    <dirname property="DSP.BUNDLES" file="${CORE.DIR}/apps/osgi-bundles/dsp"/>
    <property name="FRAMEWORK" location="${DSP.BUNDLES}/DSPFramework"/>
    <property name="PLATFORM" location="${DSP.BUNDLES}/DSPPlatform"/>
    <property name="THIRDPARTY" location="${CORE.DIR}/thirdparty"/>
    <property name="DSP.RUNTIME" location="${CORE.DIR}/runtime"/>
	<property name="DSP.DEPLOYMENT" location="${DSP.RUNTIME}/deployment"/>
	<property name="DSP.VERSION" value="0.1"/>

	<path id="project.class.path">
	       <pathelement location="./lib/"/>
	        <fileset dir="${DSP.RUNTIME}/libs">
	           <include name="**/*.jar"/>
	        </fileset>
	        <fileset dir="${THIRDPARTY}">
	          <include name="**/*.jar"/>
	       </fileset>
	</path>
	
    <!-- Defines which versions of thirdparty jars to use 
    <property file="${CORE}/tools/ant/thirdparty.properties"/>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="${THIRDPARTY}/ant-contrib/${ant-contrib.version}/ant-contrib-${ant-contrib.version}.jar"/>
        </classpath>
    </taskdef>
-->
    <echo message="CORE.DIR=${CORE.DIR}"/>
    <echo message="DSP.BUNDLES=${DSP.BUNDLES}"/>
	<echo message="FRAMEWORK=${FRAMEWORK}"/>
	<echo message="PLATFORM=${PLATFORM}"/>
	<echo message="THIRDPARTY=${THIRDPARTY}"/>
	<echo message="DSP.RUNTIME=${DSP.RUNTIME}"/>
	<echo message="DSP.VERSION=${DSP.VERSION}"/>
	<echo message="imported.basedir=${imported.basedir}"/>
	<echo message="running.file=${running.file}"/>
	
	<target name="setup">
    	<!-- Setting up runtime directory -->
    	<mkdir dir="${DSP.RUNTIME}"/>
    	
    	<mkdir dir="${DSP.RUNTIME}/demos/stocks/" />
    	<echo file="${DSP.RUNTIME}/demos/stocks/config.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<components>
    <component>
	   <name>DSPStockData</name>
	   <bundle>DSPStockData-0.1.jar</bundle>
	   <priority>20</priority>
	   <required/>
	</component>    
	<component>
	   <name>DSPStockProducer</name>
	   <bundle>DSPStockProducer-0.1.jar</bundle>
	   <priority>70</priority>
	   <required/>
	</component>
	<component>
	   <name>DSPStockConsumer</name>
	   <bundle>DSPStockConsumer-0.1.jar</bundle>
	   <priority>71</priority>
	   <required/>
    </component>
</components>
]]></echo>
	
    	<mkdir dir="${DSP.DEPLOYMENT}/"/>
    	<copy file="${DSP.RUNTIME}/demos/stocks/config.xml" todir="${DSP.DEPLOYMENT}/" />
        <echo file="${DSP.RUNTIME}/matcher_config.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<config>
    <matchRule>
        <matchCriteria>
            <nodeAddress>LOCAL</nodeAddress>
            <componentType>org.netbeams.dsp.demo.stocks.producer</componentType>
            <!-- <messageType>org.dsp.message.CreateMessage</messageType> -->
        </matchCriteria>
        <matchTarget>

            <nodeAddress>LOCAL</nodeAddress>
            <componentType>org.netbeams.dsp.demo.stocks.consumer</componentType>
        </matchTarget>
    </matchRule>
    <matchRule>
        <matchCriteria>
            <nodeAddress>LOCAL</nodeAddress>

            <componentType>ALL</componentType>
            <!-- <messageType>org.dsp.message.CreateMessage</messageType> -->
        </matchCriteria>
        <matchTarget>
            <nodeAddress>LOCAL</nodeAddress>
            <componentType>org.netbeams.dsp.platform.channel</componentType>
        </matchTarget>
    </matchRule>
</config>]]></echo>
		
        <echo file="${DSP.RUNTIME}/log4j.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">
<log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/">
  <appender name="console" class="org.apache.log4j.ConsoleAppender">
    <param name="Target" value="System.out" />
    <layout class="org.apache.log4j.PatternLayout">
      <param name="ConversionPattern"
            value="%d{ISO8601}; %-5p [%t] %c{1}: %m%n" />
    </layout>
  </appender>
  <root>
    <priority value="info" />
    <appender-ref ref="console" />
  </root>
</log4j:configuration>]]></echo>
	
        <echo file="${DSP.RUNTIME}/${DSP.KNOPFLERFISH.EXEC}">#### Linux #####
export DSP_HOME="${DSP.RUNTIME}"
export KNOPFLERFISH_HOME="${KNOPFLERFISH.HOME}"
####################

#### Windows ####
# set DSP_HOME="${DSP.RUNTIME}"
# set KNOPFLERFISH_HOME="${KNOPFLERFISH.HOME}"
#################

echo "#########################################"
echo "## Running DSP${DSP.VERSION} OSGi version for Knopflerfish..."
echo "## * DSP_HOME=$DSP_HOME"
echo "## * KNOPFLERFISH_HOME=$KNOPFLERFISH_HOME"
java -Dlog4j.configuration="file:$DSP_HOME/log4j.xml" -jar framework.jar

        </echo>
		<chmod perm="+x" file="${DSP.RUNTIME}/${DSP.KNOPFLERFISH.EXEC}" />
		<move file="${DSP.RUNTIME}/${DSP.KNOPFLERFISH.EXEC}" todir="${KNOPFLERFISH.HOME}/osgi" />
	</target>
	
	<target name="clear-runtime">
		   <delete dir="${DSP.RUNTIME}/" />
	</target>
</project>